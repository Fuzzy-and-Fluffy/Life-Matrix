<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeMatrix - 无限游戏</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- 核心库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Noto+Sans+SC:wght@400;500;700;900&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- PWA Service Worker 注册与自动更新 ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('SW registered');

                        // 检查更新
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // 新版本已安装，自动激活并刷新
                                    console.log('New version available, updating...');
                                    newWorker.postMessage('skipWaiting');
                                }
                            });
                        });
                    })
                    .catch(err => console.log('SW failed', err));

                // 当新 SW 接管时，自动刷新页面
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        refreshing = true;
                        console.log('Refreshing for new version...');
                        window.location.reload();
                    }
                });
            });
        }

        // --- Firebase 配置 ---
        const firebaseConfig = {
            apiKey: "AIzaSyBH1q0cAYUfKg04brS2JN4Rmm4FSqne2JU",
            authDomain: "life-matrix-c6b45.firebaseapp.com",
            projectId: "life-matrix-c6b45",
            storageBucket: "life-matrix-c6b45.firebasestorage.app",
            messagingSenderId: "586491009176",
            appId: "1:586491009176:web:3c60fce03bc5e8033098ed",
            measurementId: "G-XTY0XDG3DF"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 启用离线持久化
        db.enablePersistence().catch(err => {
            if (err.code === 'failed-precondition') {
                console.log('Multiple tabs open, persistence enabled in first tab only');
            } else if (err.code === 'unimplemented') {
                console.log('Browser does not support persistence');
            }
        });

        // ==========================================
        // 1. 图标库
        // ==========================================
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                user: <g><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></g>,
                plus: <g><path d="M5 12h14" /><path d="M12 5v14" /></g>,
                check: <polyline points="20 6 9 17 4 12" />,
                camera: <g><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" /><circle cx="12" cy="13" r="3" /></g>,
                sparkle: <g><polygon points="12,2 4,18 20,18" fill="none" strokeWidth="2" /><polygon points="12,22 4,6 20,6" fill="none" strokeWidth="2" /></g>,
                history: <g><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M12 7v5l4 2" /></g>,
                scale: <g><path d="M16 16c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2z" /><path d="M12 16c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2z" /><path d="M20 10c0-4.4-3.6-8-8-8s-8 3.6-8 8" /><path d="M4 10h16" /><path d="M12 10v10" /></g>,
                clock: <g><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></g>,
                left: <path d="m15 18-6-6 6-6" />,
                right: <path d="m9 18 6-6-6-6" />,
                fast: <path d="m13 2-2 10h9L11 22l2-10H4L13 2Z" />,
                close: <g><path d="M18 6 6 18" /><path d="m6 6 12 12" /></g>,
                settings: <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></g>,
                download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></g>,
                upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></g>,
                table: <g><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><line x1="3" x2="21" y1="9" y2="9" /><line x1="3" x2="21" y1="15" y2="15" /><line x1="12" x2="12" y1="3" y2="21" /></g>,
                cloud: <g><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z" /></g>,
                cloudOff: <g><path d="m2 2 20 20" /><path d="M5.782 5.782A7 7 0 0 0 9 19h8.5a4.5 4.5 0 0 0 1.307-.193" /><path d="M21.532 16.532A4.5 4.5 0 0 0 17.5 10h-1.79a7 7 0 0 0-1.926-3.535" /></g>,
                google: <g><path d="M12.545 10.239v3.821h5.445c-.712 2.315-2.647 3.972-5.445 3.972a6.033 6.033 0 1 1 0-12.064c1.498 0 2.866.549 3.921 1.453l2.814-2.814A9.969 9.969 0 0 0 12.545 2C7.021 2 2.543 6.477 2.543 12s4.478 10 10.002 10c8.396 0 10.249-7.85 9.426-11.748l-9.426-.013z" fill="currentColor" stroke="none" /></g>,
                logout: <g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></g>,
                edit: <g><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" /><path d="m15 5 4 4" /></g>,
                trash: <g><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /></g>,
                folder: <g><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z" /></g>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || icons['user']}
                </svg>
            );
        };

        // ==========================================
        // 2. 常量与算法
        // ==========================================
        const INITIAL_DIMS = [
            { id: 'dim_1', name: "身心健康", active: true, color: "bg-emerald-400", text: "text-emerald-500", border: "border-emerald-100" },
            { id: 'dim_2', name: "工作事业", active: true, color: "bg-blue-400", text: "text-blue-500", border: "border-blue-100" },
            { id: 'dim_3', name: "财务状况", active: true, color: "bg-amber-400", text: "text-amber-500", border: "border-amber-100" },
            { id: 'dim_4', name: "家庭关系", active: true, color: "bg-rose-400", text: "text-rose-500", border: "border-rose-100" },
            { id: 'dim_5', name: "社交连接", active: true, color: "bg-purple-400", text: "text-purple-500", border: "border-purple-100" },
            { id: 'dim_6', name: "个人成长", active: true, color: "bg-indigo-400", text: "text-indigo-500", border: "border-indigo-100" },
            { id: 'dim_7', name: "精神生活", active: false, color: "bg-cyan-400", text: "text-cyan-500", border: "border-cyan-100" },
            { id: 'dim_8', name: "休闲玩乐", active: false, color: "bg-orange-400", text: "text-orange-500", border: "border-orange-100" },
        ];

        const calculateLevel = (score) => {
            if (!score || score < 5) return 0;
            return Math.floor(-2 + Math.sqrt(4 + score));
        };

        const getProgress = (score) => {
            const level = calculateLevel(score);
            const sStart = level * level + 4 * level;
            const nextL = level + 1;
            const sEnd = nextL * nextL + 4 * nextL;
            const needed = sEnd - sStart;
            return needed > 0 ? ((score - sStart) / needed) * 100 : 0;
        };

        const calculateBalance = (scores) => {
            if (!scores || scores.length === 0) return 100;
            const sum = scores.reduce((a, b) => a + b, 0);
            if (sum === 0) return 100;
            const mean = sum / scores.length;
            const variance = scores.reduce((acc, s) => acc + Math.pow(s - mean, 2), 0) / scores.length;
            return Math.round(Math.max(0, 100 - (Math.sqrt(variance) / mean) * 100));
        };

        // ==========================================
        // 3. 子组件
        // ==========================================

        const RadarChart = ({ dimensions, scores, onLabelClick, size = 400 }) => {
            const activeDims = (dimensions || []).filter(d => d.active);
            if (activeDims.length < 3) return null;

            // ViewBox with padding for labels
            const padding = 50;
            const viewBoxSize = size + padding * 2;
            const centerX = viewBoxSize / 2;
            const centerY = viewBoxSize / 2;
            const radius = 125;
            const baseLabelDist = 155;

            const getPos = (i, total, r, isLabel = false) => {
                const angle = (i * 2 * Math.PI) / total - Math.PI / 2;
                const sin = Math.sin(angle);

                // For labels, adjust distance based on angle to achieve uniform visual spacing
                // Text block extends ~25px below anchor, so:
                // - Top labels (sin < -0.5): need MORE distance (text hangs down toward radar)
                // - Bottom labels (sin > 0.5): need LESS extra distance (text hangs away from radar)
                let adjustedR = r;
                if (isLabel) {
                    // Top labels: push further out
                    if (sin < -0.5) {
                        adjustedR = r + Math.abs(sin) * 15;
                    }
                    // Side labels at horizontal positions need slight adjustment
                    // No extra adjustment needed for bottom labels
                }
                return { x: centerX + adjustedR * Math.cos(angle), y: centerY + adjustedR * Math.sin(angle), angle };
            };

            const polyPoints = activeDims.map((dim, i) => {
                const idx = dimensions.findIndex(d => d.id === dim.id);
                const s = (scores && scores[idx]) ? scores[idx] : 0;
                const level = calculateLevel(s);
                const r = Math.min(radius, (level / 15) * radius + 25);
                return getPos(i, activeDims.length, r);
            });

            return (
                <div className="w-full flex justify-center items-center overflow-visible">
                    <svg width="100%" height="100%" viewBox={`0 0 ${viewBoxSize} ${viewBoxSize}`} className="overflow-visible select-none max-w-[460px]">
                        {[1, 0.75, 0.5, 0.25].map(s => (
                            <circle key={s} cx={centerX} cy={centerY} r={radius * s} fill="none" stroke="#f1f5f9" strokeWidth={s === 1 ? "2.5" : "1.5"} />
                        ))}

                        {activeDims.map((dim, i) => {
                            const axisPos = getPos(i, activeDims.length, radius);
                            const labelPos = getPos(i, activeDims.length, baseLabelDist, true);

                            const idx = dimensions.findIndex(d => d.id === dim.id);
                            const score = (scores && scores[idx]) ? scores[idx] : 0;
                            const level = calculateLevel(score);
                            const progress = getProgress(score);

                            const cos = Math.cos(labelPos.angle);
                            let blockXOffset = 0;
                            if (cos < -0.3) blockXOffset = -85;
                            else if (Math.abs(cos) <= 0.3) blockXOffset = -42;

                            return (
                                <g key={dim.id}
                                    className="group cursor-pointer active:opacity-60 transition-all"
                                    onClick={() => onLabelClick(idx)}
                                    transform={`translate(${labelPos.x + blockXOffset}, ${labelPos.y})`}
                                >
                                    <line x1={centerX - (labelPos.x + blockXOffset)} y1={centerY - labelPos.y} x2={axisPos.x - (labelPos.x + blockXOffset)} y2={axisPos.y - labelPos.y} stroke="#f1f5f9" strokeWidth="2.5" />
                                    <circle cx={axisPos.x - (labelPos.x + blockXOffset)} cy={axisPos.y - labelPos.y} r="4.5" fill="#cbd5e1" stroke="white" strokeWidth="2" />

                                    <text x="0" y="-10" textAnchor="start" className="text-[16px] font-black fill-slate-800 uppercase tracking-tight">
                                        {dim.name}
                                    </text>

                                    <g transform="translate(0, 12)">
                                        <text x="0" y="0" textAnchor="start" className="text-[12px] font-bold fill-sky-500">
                                            Lv.{level}
                                        </text>
                                        <g transform={`translate(42, -4)`}>
                                            <rect width="32" height="4.5" fill="#f1f5f9" rx="2.25" />
                                            <rect width={32 * (progress / 100)} height="4.5" fill="#0ea5e9" rx="2.25" className="transition-all duration-1000 ease-out" />
                                        </g>
                                    </g>
                                    <rect x="-15" y="-35" width="120" height="70" fill="transparent" />
                                </g>
                            );
                        })}

                        {polyPoints.length > 2 && (
                            <polygon
                                points={polyPoints.map(p => `${p.x},${p.y}`).join(' ')}
                                fill="rgba(14, 165, 233, 0.18)"
                                stroke="#0ea5e9"
                                strokeWidth="6"
                                strokeLinejoin="miter"
                                className="transition-all duration-700 ease-out"
                            />
                        )}
                    </svg>
                </div>
            );
        };

        const RecordModal = ({ dimName, onClose, onConfirm, history, systemTags = [], currentDimId, initialText = "", initialTags = [], isEdit = false }) => {
            const [text, setText] = useState(initialText);
            const inputRef = useRef(null);

            // System default tags
            const SYSTEM_DEFAULTS = ['第一次', '里程碑'];

            // 当 initialText 改变时，更新状态
            useEffect(() => {
                setText(initialText);
            }, [initialText]);

            // Get last 10 used tags from history for THIS dimension only
            const tagSuggestions = useMemo(() => {
                if (!history || history.length === 0) return SYSTEM_DEFAULTS;

                // Extract tags only from records in the current dimension
                const dimensionTags = history
                    .filter(h => h.dimName === dimName && h.tags && h.tags.length > 0)
                    .flatMap(h => h.tags);

                // Get unique tags preserving order (most recent first)
                const uniqueTags = [...new Set(dimensionTags)].slice(0, 10);

                // If less than 10, add system defaults (available for all dimensions)
                if (uniqueTags.length < 10) {
                    SYSTEM_DEFAULTS.forEach(tag => {
                        if (!uniqueTags.includes(tag) && uniqueTags.length < 10) {
                            uniqueTags.push(tag);
                        }
                    });
                }

                return uniqueTags.length > 0 ? uniqueTags : SYSTEM_DEFAULTS;
            }, [history, dimName]);

            const suggestions = useMemo(() => {
                if (!history) return [];
                return history
                    .filter(h => h.dimName === dimName)
                    .map(h => h.text)
                    .filter((val, idx, arr) => arr.indexOf(val) === idx)
                    .slice(0, 10);
            }, [history, dimName]);

            // Insert tag at cursor position in 【】 format
            const insertTag = (tag) => {
                const tagStr = `【${tag}】`;
                const input = inputRef.current;
                if (!input) {
                    setText(prev => prev + tagStr);
                    return;
                }

                const start = input.selectionStart;
                const end = input.selectionEnd;
                const newText = text.substring(0, start) + tagStr + text.substring(end);
                setText(newText);

                // Focus back and move cursor after injected tag
                input.focus();
                setTimeout(() => {
                    const newPos = start + tagStr.length;
                    input.selectionStart = input.selectionEnd = newPos;
                }, 0);
            };

            const handleConfirm = () => {
                onConfirm(text);
            };

            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-6 z-50 animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl flex flex-col gap-5">
                        <div>
                            <h3 className="text-xl font-black text-slate-800 mb-1">{isEdit ? '编辑记录' : '记录进度'}</h3>
                            <p className="text-xs text-slate-400 mb-2 uppercase tracking-widest font-bold">领域: {dimName}</p>
                        </div>
                        <div className="space-y-4">
                            {/* Main text input */}
                            <textarea
                                ref={inputRef}
                                autoFocus
                                rows={5}
                                value={text}
                                onChange={e => setText(e.target.value)}
                                placeholder="输入内容，点击标签可插入【标签】...&#10;&#10;提示：Enter换行，Ctrl+Enter提交"
                                className="w-full bg-slate-50 border-none rounded-2xl px-6 py-5 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-sky-100 transition-all resize-none"
                                onKeyDown={e => {
                                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                                        e.preventDefault();
                                        handleConfirm();
                                    }
                                }}
                            />

                            {/* Tag Suggestions - Click to insert 【tag】 into text */}
                            <div className="space-y-2">
                                <p className="text-[9px] font-black text-slate-300 uppercase tracking-widest px-1">点击插入标签</p>
                                <div className="flex flex-wrap gap-1.5">
                                    {tagSuggestions.map((tag, i) => (
                                        <button
                                            key={i}
                                            onClick={() => insertTag(tag)}
                                            className="bg-violet-50 hover:bg-violet-100 border border-violet-100 hover:border-violet-200 text-violet-500 hover:text-violet-600 px-2.5 py-1 rounded-lg text-[10px] font-bold transition-colors"
                                        >
                                            【{tag}】
                                        </button>
                                    ))}
                                </div>
                                <p className="text-[9px] text-slate-300 px-1 italic">提示：你也可以手动输入【内容】来创建新标签</p>
                            </div>

                            {/* Recent records suggestions */}
                            {suggestions.length > 0 && (
                                <div className="space-y-2 pt-2 border-t border-slate-50">
                                    <p className="text-[10px] font-black text-slate-300 uppercase tracking-widest px-1">最近记录 (点击填入)</p>
                                    <div className="flex flex-wrap gap-2 max-h-[80px] overflow-y-auto no-scrollbar">
                                        {suggestions.map((txt, i) => (
                                            <button key={i} onClick={() => setText(txt)} className="bg-slate-100/50 hover:bg-slate-100 px-3 py-2 rounded-xl text-[11px] font-bold text-slate-400 transition-colors text-left max-w-full truncate border border-slate-100">{txt}</button>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="flex flex-col gap-3 mt-2">
                            <button onClick={handleConfirm} className="w-full bg-sky-600 text-white py-4.5 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-sky-100 hover:bg-sky-500 active:scale-95 transition-all">{isEdit ? '保存更改' : '确认进度'}</button>
                            <button onClick={onClose} className="w-full text-slate-300 font-bold text-xs uppercase tracking-widest py-2">取消</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 头像裁剪模态框 - 支持拖拽和缩放
        const AvatarCropModal = ({ imageSrc, onConfirm, onCancel }) => {
            const containerRef = useRef(null);
            const [scale, setScale] = useState(1);
            const [position, setPosition] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
            const [imageSize, setImageSize] = useState({ width: 0, height: 0 });

            const CROP_SIZE = 200; // 裁剪框直径

            // 计算初始缩放使图片填满裁剪区域
            useEffect(() => {
                const img = new Image();
                img.onload = () => {
                    setImageSize({ width: img.width, height: img.height });
                    const minScale = Math.max(CROP_SIZE / img.width, CROP_SIZE / img.height);
                    setScale(minScale * 1.2);
                };
                img.src = imageSrc;
            }, [imageSrc]);

            const handleMouseDown = (e) => {
                e.preventDefault();
                setIsDragging(true);
                setDragStart({ x: e.clientX - position.x, y: e.clientY - position.y });
            };

            const handleMouseMove = (e) => {
                if (!isDragging) return;
                setPosition({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
            };

            const handleMouseUp = () => setIsDragging(false);

            const handleWheel = (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.95 : 1.05;
                setScale(s => Math.max(0.1, Math.min(5, s * delta)));
            };

            const handleTouchStart = (e) => {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    setIsDragging(true);
                    setDragStart({ x: touch.clientX - position.x, y: touch.clientY - position.y });
                }
            };

            const handleTouchMove = (e) => {
                if (!isDragging || e.touches.length !== 1) return;
                e.preventDefault();
                const touch = e.touches[0];
                setPosition({ x: touch.clientX - dragStart.x, y: touch.clientY - dragStart.y });
            };

            const handleCrop = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 150;
                canvas.height = 150;

                const img = new Image();
                img.onload = () => {
                    const containerRect = containerRef.current?.getBoundingClientRect();
                    if (!containerRect) return;

                    // 计算裁剪区域在原始图片上的位置
                    const centerX = containerRect.width / 2;
                    const centerY = containerRect.height / 2;

                    // 图片左上角相对于容器中心的偏移（考虑缩放）
                    const imgOffsetX = centerX + position.x - (imageSize.width * scale) / 2;
                    const imgOffsetY = centerY + position.y - (imageSize.height * scale) / 2;

                    // 裁剪区域左上角相对于图片的位置（原始尺寸）
                    const cropLeft = (centerX - CROP_SIZE / 2 - imgOffsetX) / scale;
                    const cropTop = (centerY - CROP_SIZE / 2 - imgOffsetY) / scale;
                    const cropSize = CROP_SIZE / scale;

                    ctx.drawImage(img, cropLeft, cropTop, cropSize, cropSize, 0, 0, 150, 150);
                    onConfirm(canvas.toDataURL('image/jpeg', 0.9));
                };
                img.src = imageSrc;
            };

            return (
                <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-4 z-[60] animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl overflow-hidden">
                        <div className="p-6 pb-4 border-b border-slate-100 text-center">
                            <h3 className="text-lg font-black text-slate-800">调整头像</h3>
                            <p className="text-[10px] text-slate-400 mt-1">拖动调整位置，滑动缩放大小</p>
                        </div>

                        <div
                            ref={containerRef}
                            className="relative w-full h-72 bg-slate-900 overflow-hidden cursor-move select-none"
                            onMouseDown={handleMouseDown}
                            onMouseMove={handleMouseMove}
                            onMouseUp={handleMouseUp}
                            onMouseLeave={handleMouseUp}
                            onWheel={handleWheel}
                            onTouchStart={handleTouchStart}
                            onTouchMove={handleTouchMove}
                            onTouchEnd={() => setIsDragging(false)}
                        >
                            <div
                                className="absolute"
                                style={{
                                    left: '50%',
                                    top: '50%',
                                    transform: `translate(calc(-50% + ${position.x}px), calc(-50% + ${position.y}px)) scale(${scale})`,
                                    transformOrigin: 'center center'
                                }}
                            >
                                <img src={imageSrc} className="max-w-none" draggable={false} />
                            </div>

                            <div className="absolute inset-0 pointer-events-none">
                                <svg className="w-full h-full">
                                    <defs>
                                        <mask id="cropMask">
                                            <rect width="100%" height="100%" fill="white" />
                                            <circle cx="50%" cy="50%" r={CROP_SIZE / 2} fill="black" />
                                        </mask>
                                    </defs>
                                    <rect width="100%" height="100%" fill="rgba(0,0,0,0.6)" mask="url(#cropMask)" />
                                    <circle cx="50%" cy="50%" r={CROP_SIZE / 2} fill="none" stroke="white" strokeWidth="2" strokeDasharray="6 4" />
                                </svg>
                            </div>
                        </div>

                        <div className="px-6 py-4 flex items-center gap-3">
                            <span className="text-[10px] text-slate-300">小</span>
                            <input
                                type="range" min="0.1" max="3" step="0.01" value={scale}
                                onChange={(e) => setScale(parseFloat(e.target.value))}
                                className="flex-1 h-1.5 bg-slate-100 rounded-full appearance-none cursor-pointer accent-sky-500"
                            />
                            <span className="text-[10px] text-slate-300">大</span>
                        </div>

                        <div className="p-6 pt-2 flex gap-3">
                            <button onClick={onCancel} className="flex-1 py-4 rounded-2xl border border-slate-200 text-slate-500 font-bold text-xs uppercase tracking-widest hover:bg-slate-50 active:scale-95 transition-all">取消</button>
                            <button onClick={handleCrop} className="flex-[2] bg-sky-500 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg hover:bg-sky-400 active:scale-95 transition-all">确认裁剪</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({
            onClose, onExportJSON, onExportCSV, onImport,
            name, avatar, dimensions, systemTags, onSave, onSignOut, currentUser
        }) => {
            const [activeTab, setActiveTab] = useState('profile'); // 'profile' | 'dimensions' | 'tags' | 'data'
            const [tempName, setTempName] = useState(name || '');
            const [tempAvatar, setTempAvatar] = useState(avatar);
            const [tempDimensions, setTempDimensions] = useState(dimensions || []);
            const [tempSystemTags, setTempSystemTags] = useState(systemTags || []);
            const [customDimName, setCustomDimName] = useState('');
            const [hasChanges, setHasChanges] = useState(false);

            // 裁剪模态框状态
            const [showCropModal, setShowCropModal] = useState(false);
            const [rawImageSrc, setRawImageSrc] = useState(null);

            const fileInput = useRef(null);
            const avatarInput = useRef(null);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => onImport(ev.target.result);
                reader.readAsText(file);
            };

            const handleAvatarChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    // 打开裁剪模态框而不是直接调整大小
                    setRawImageSrc(ev.target.result);
                    setShowCropModal(true);
                };
                reader.readAsDataURL(file);
                e.target.value = ''; // 重置以便可以选择同一文件
            };

            const handleCropConfirm = (croppedDataUrl) => {
                setTempAvatar(croppedDataUrl);
                setHasChanges(true);
                setShowCropModal(false);
                setRawImageSrc(null);
            };

            const handleCropCancel = () => {
                setShowCropModal(false);
                setRawImageSrc(null);
            };

            const handleSave = () => {
                onSave(tempName, tempAvatar, tempDimensions, tempSystemTags);
                setHasChanges(false);
                onClose();
            };

            const updateDimName = (idx, newName) => {
                const newDims = [...tempDimensions];
                newDims[idx].name = newName;
                setTempDimensions(newDims);
                setHasChanges(true);
            };

            const toggleDimActive = (idx) => {
                const activeCount = tempDimensions.filter(d => d.active).length;
                if (tempDimensions[idx].active && activeCount <= 3) return;
                const newDims = [...tempDimensions];
                newDims[idx].active = !newDims[idx].active;
                setTempDimensions(newDims);
                setHasChanges(true);
            };

            const addCustomDim = () => {
                if (!customDimName.trim() || tempDimensions.length >= 12) return;
                const newDims = [...tempDimensions, {
                    id: `c_${Date.now()}`,
                    name: customDimName,
                    active: true,
                    color: "bg-slate-400",
                    text: "text-slate-400",
                    border: "border-slate-200"
                }];
                setTempDimensions(newDims);
                setCustomDimName('');
                setHasChanges(true);
            };

            const TabButton = ({ id, label }) => (
                <button
                    onClick={() => setActiveTab(id)}
                    className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${activeTab === id
                        ? 'bg-slate-900 text-white shadow-sm'
                        : 'text-slate-400 hover:text-slate-600 hover:bg-slate-50'
                        }`}
                >
                    {label}
                </button>
            );

            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4 z-50 animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl flex flex-col max-h-[85vh] overflow-hidden">
                        {/* Header */}
                        <div className="p-6 pb-4 border-b border-slate-100">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xl font-black text-slate-800">设置</h3>
                                <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><Icon name="close" /></button>
                            </div>
                            {/* Tabs */}
                            <div className="flex gap-2 flex-wrap">
                                <TabButton id="profile" label="个人资料" />
                                <TabButton id="dimensions" label="维度管理" />
                                <TabButton id="tags" label="标签管理" />
                                <TabButton id="data" label="数据" />
                            </div>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6 no-scrollbar">
                            {activeTab === 'profile' && (
                                <div className="space-y-6">
                                    {/* Avatar */}
                                    <div className="flex flex-col items-center">
                                        <div
                                            className="relative cursor-pointer group mb-4"
                                            onClick={() => avatarInput.current.click()}
                                        >
                                            <div className={`w-24 h-24 rounded-[2rem] flex items-center justify-center overflow-hidden transition-all border-2 ${tempAvatar ? 'border-sky-100 shadow-xl' : 'bg-slate-50 border-dashed border-slate-200 group-hover:border-sky-300'
                                                }`}>
                                                {tempAvatar
                                                    ? <img src={tempAvatar} className="w-full h-full object-cover" />
                                                    : <Icon name="user" size={32} className="text-slate-300" />
                                                }
                                            </div>
                                            <div className="absolute -bottom-1 -right-1 bg-white p-2 rounded-xl shadow border border-slate-50 text-slate-400 group-hover:text-sky-500 transition-colors">
                                                <Icon name="camera" size={14} />
                                            </div>
                                            <input type="file" ref={avatarInput} className="hidden" accept="image/*" onChange={handleAvatarChange} />
                                        </div>
                                        <p className="text-[10px] text-slate-400 font-bold">点击更换头像</p>
                                    </div>

                                    {/* Name */}
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">用户名</label>
                                        <input
                                            type="text"
                                            value={tempName}
                                            onChange={e => { setTempName(e.target.value); setHasChanges(true); }}
                                            placeholder="输入你的昵称"
                                            className="w-full bg-slate-50 rounded-2xl px-5 py-4 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-sky-100 transition-all"
                                        />
                                    </div>
                                </div>
                            )}

                            {activeTab === 'dimensions' && (
                                <div className="space-y-4">
                                    <p className="text-[10px] font-bold text-slate-400 mb-4">编辑维度名称，点击右侧按钮启用/禁用（至少保留3个）</p>
                                    <div className="space-y-2">
                                        {tempDimensions.map((dim, idx) => (
                                            <div key={dim.id} className={`flex items-center gap-3 p-3 rounded-2xl border transition-all ${dim.active ? 'bg-slate-50 border-slate-100' : 'opacity-40 border-transparent'
                                                }`}>
                                                <div className={`w-3 h-3 rounded-full ${dim.color}`}></div>
                                                <input
                                                    type="text"
                                                    value={dim.name}
                                                    onChange={e => updateDimName(idx, e.target.value)}
                                                    className="flex-1 bg-transparent border-none p-0 focus:ring-0 font-bold text-sm text-slate-700 outline-none"
                                                />
                                                <button
                                                    onClick={() => toggleDimActive(idx)}
                                                    className={`shrink-0 w-8 h-8 rounded-xl flex items-center justify-center transition-all ${dim.active
                                                        ? 'bg-sky-500 text-white shadow-md'
                                                        : 'bg-white border border-slate-200 text-slate-300'
                                                        }`}
                                                >
                                                    {dim.active ? <Icon name="check" size={14} /> : <Icon name="plus" size={14} />}
                                                </button>
                                            </div>
                                        ))}
                                    </div>

                                    {/* Add new dimension */}
                                    {tempDimensions.length < 12 && (
                                        <div className="flex gap-2 mt-4">
                                            <input
                                                type="text"
                                                value={customDimName}
                                                onChange={e => setCustomDimName(e.target.value)}
                                                placeholder="添加新维度..."
                                                className="flex-1 bg-slate-50 rounded-xl px-4 py-3 text-xs font-bold outline-none focus:ring-2 focus:ring-sky-100"
                                                onKeyDown={e => e.key === 'Enter' && addCustomDim()}
                                            />
                                            <button
                                                onClick={addCustomDim}
                                                className="bg-slate-900 text-white w-10 rounded-xl flex items-center justify-center shadow-lg"
                                            >
                                                <Icon name="plus" size={16} />
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}

                            {activeTab === 'tags' && (
                                <div className="space-y-4">
                                    <p className="text-[10px] font-bold text-slate-400 mb-4">管理系统标签，标签可以应用到一个或多个维度</p>
                                    <div className="space-y-2">
                                        {tempSystemTags.map((tag, idx) => (
                                            <div key={tag.id} className="flex flex-col gap-2 p-3 rounded-2xl bg-slate-50 border border-slate-100">
                                                <div className="flex items-center gap-3">
                                                    <input
                                                        type="text"
                                                        value={tag.name}
                                                        onChange={e => {
                                                            const newTags = [...tempSystemTags];
                                                            newTags[idx].name = e.target.value;
                                                            setTempSystemTags(newTags);
                                                            setHasChanges(true);
                                                        }}
                                                        className="flex-1 bg-white rounded-xl px-4 py-2 font-bold text-sm text-slate-700 outline-none focus:ring-2 focus:ring-violet-100 transition-all"
                                                        placeholder="标签名称"
                                                    />
                                                    <button
                                                        onClick={() => {
                                                            setTempSystemTags(tempSystemTags.filter((_, i) => i !== idx));
                                                            setHasChanges(true);
                                                        }}
                                                        className="shrink-0 w-8 h-8 rounded-xl flex items-center justify-center bg-white border border-slate-200 text-slate-400 hover:bg-rose-50 hover:text-rose-500 hover:border-rose-200 transition-all"
                                                    >
                                                        <Icon name="trash" size={14} />
                                                    </button>
                                                </div>
                                                {/* 维度选择 */}
                                                <div className="flex flex-col gap-1.5">
                                                    <p className="text-[9px] font-black text-slate-300 uppercase tracking-widest px-1">应用到维度 (空=所有维度)</p>
                                                    <div className="flex flex-wrap gap-1.5">
                                                        {tempDimensions.filter(d => d.active).map((dim) => {
                                                            const isSelected = tag.appliesTo.length === 0 || tag.appliesTo.includes(dim.id);
                                                            const isAll = tag.appliesTo.length === 0;
                                                            return (
                                                                <button
                                                                    key={dim.id}
                                                                    onClick={() => {
                                                                        const newTags = [...tempSystemTags];
                                                                        if (isAll) {
                                                                            // 如果当前是"所有"，点击后只选中这个维度
                                                                            newTags[idx].appliesTo = [dim.id];
                                                                        } else if (tag.appliesTo.includes(dim.id)) {
                                                                            // 取消选中
                                                                            const filtered = tag.appliesTo.filter(id => id !== dim.id);
                                                                            newTags[idx].appliesTo = filtered.length === 0 ? [] : filtered;
                                                                        } else {
                                                                            // 添加选中
                                                                            newTags[idx].appliesTo = [...tag.appliesTo, dim.id];
                                                                        }
                                                                        setTempSystemTags(newTags);
                                                                        setHasChanges(true);
                                                                    }}
                                                                    className={`px-2.5 py-1 rounded-lg text-[10px] font-bold transition-all ${isAll
                                                                        ? 'bg-violet-100 text-violet-600 border border-violet-200'
                                                                        : isSelected
                                                                            ? 'bg-violet-100 text-violet-600 border border-violet-200'
                                                                            : 'bg-white border border-slate-200 text-slate-400 hover:border-violet-200 hover:text-violet-500'
                                                                        }`}
                                                                >
                                                                    {dim.name}
                                                                </button>
                                                            );
                                                        })}
                                                        <button
                                                            onClick={() => {
                                                                const newTags = [...tempSystemTags];
                                                                newTags[idx].appliesTo = [];
                                                                setTempSystemTags(newTags);
                                                                setHasChanges(true);
                                                            }}
                                                            className={`px-2.5 py-1 rounded-lg text-[10px] font-bold transition-all ${tag.appliesTo.length === 0
                                                                ? 'bg-sky-100 text-sky-600 border border-sky-200'
                                                                : 'bg-white border border-slate-200 text-slate-400 hover:border-sky-200 hover:text-sky-500'
                                                                }`}
                                                        >
                                                            所有维度
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    {/* 添加新标签 */}
                                    <button
                                        onClick={() => {
                                            const newTag = {
                                                id: `tag_${Date.now()}`,
                                                name: '',
                                                appliesTo: []
                                            };
                                            setTempSystemTags([...tempSystemTags, newTag]);
                                            setHasChanges(true);
                                        }}
                                        className="w-full bg-slate-50 border border-slate-200 hover:bg-slate-100 py-3 rounded-2xl flex items-center justify-center gap-2 transition-all"
                                    >
                                        <Icon name="plus" size={16} className="text-slate-400" />
                                        <span className="font-bold text-xs text-slate-500">添加新标签</span>
                                    </button>
                                </div>
                            )}

                            {activeTab === 'data' && (
                                <div className="space-y-3">
                                    <button onClick={onExportCSV} className="w-full bg-emerald-50 border border-emerald-100 hover:bg-emerald-100 py-4 rounded-2xl flex items-center justify-center gap-3 transition-all group">
                                        <span className="p-1.5 bg-white rounded-full shadow-sm text-emerald-500 group-hover:scale-110 transition-transform"><Icon name="table" size={16} /></span>
                                        <span className="font-bold text-xs text-emerald-700">导出为 Excel (CSV)</span>
                                    </button>
                                    <button onClick={onExportJSON} className="w-full bg-slate-50 border border-slate-100 hover:bg-slate-100 py-4 rounded-2xl flex items-center justify-center gap-3 transition-all group">
                                        <span className="p-1.5 bg-white rounded-full shadow-sm text-sky-500 group-hover:scale-110 transition-transform"><Icon name="download" size={16} /></span>
                                        <span className="font-bold text-xs text-slate-600">备份存档 (JSON)</span>
                                    </button>
                                    <div className="relative">
                                        <input type="file" accept=".json" ref={fileInput} className="hidden" onChange={handleFileChange} />
                                        <button onClick={() => fileInput.current.click()} className="w-full bg-slate-50 border border-slate-100 hover:bg-slate-100 py-4 rounded-2xl flex items-center justify-center gap-3 transition-all group">
                                            <span className="p-1.5 bg-white rounded-full shadow-sm text-purple-500 group-hover:scale-110 transition-transform"><Icon name="fast" size={16} /></span>
                                            <span className="font-bold text-xs text-slate-600">恢复存档</span>
                                        </button>
                                    </div>

                                    {/* 退出登录 */}
                                    {currentUser && (
                                        <div className="pt-4 mt-4 border-t border-slate-100">
                                            <button
                                                onClick={() => { onSignOut(); onClose(); }}
                                                className="w-full bg-rose-50 border border-rose-100 hover:bg-rose-100 py-4 rounded-2xl flex items-center justify-center gap-3 transition-all group"
                                            >
                                                <span className="p-1.5 bg-white rounded-full shadow-sm text-rose-500 group-hover:scale-110 transition-transform"><Icon name="logout" size={16} /></span>
                                                <span className="font-bold text-xs text-rose-600">退出登录</span>
                                            </button>
                                            <p className="text-[10px] text-slate-300 text-center mt-2">当前账号: {currentUser.email}</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="p-6 pt-4 border-t border-slate-100">
                            {(activeTab === 'profile' || activeTab === 'dimensions' || activeTab === 'tags') && hasChanges ? (
                                <button
                                    onClick={handleSave}
                                    className="w-full bg-sky-500 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg shadow-sky-100 hover:bg-sky-400 active:scale-95 transition-all"
                                >
                                    保存更改
                                </button>
                            ) : (
                                <p className="text-[9px] text-center text-slate-300">LifeMatrix v3.5</p>
                            )}
                        </div>
                    </div>

                    {/* 头像裁剪模态框 */}
                    {showCropModal && rawImageSrc && (
                        <AvatarCropModal
                            imageSrc={rawImageSrc}
                            onConfirm={handleCropConfirm}
                            onCancel={handleCropCancel}
                        />
                    )}
                </div>
            );
        };

        const MonthlyHistoryModal = ({ onClose, history, dimensions }) => {
            const [currDate, setCurrDate] = useState(new Date());

            const year = currDate.getFullYear();
            const month = currDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();

            const changeMonth = (delta) => setCurrDate(new Date(year, month + delta, 1));

            const currentMonthData = useMemo(() => {
                return (history || []).filter(h => {
                    const d = new Date(h.timestamp || Date.now());
                    return d.getMonth() === month && d.getFullYear() === year;
                });
            }, [history, month, year]);

            const activeDims = dimensions.filter(d => d.active);

            const MiniCalendarCard = ({ dim }) => {
                const punchSet = new Set(
                    currentMonthData
                        .filter(h => h.dimName === dim.name)
                        .map(h => new Date(h.timestamp).getDate())
                );
                const blanks = Array(firstDay).fill(null);
                const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);

                return (
                    <div className={`bg-white p-3 rounded-2xl border ${dim.border || 'border-slate-100'} shadow-sm flex flex-col h-full`}>
                        <div className="flex justify-between items-baseline mb-2">
                            <span className={`text-[10px] font-black uppercase tracking-tight truncate max-w-[80px] ${dim.text?.replace('bg-', 'text-') || 'text-slate-500'}`}>{dim.name}</span>
                            <span className="text-[9px] font-bold text-slate-300">{punchSet.size}d</span>
                        </div>
                        <div className="grid grid-cols-7 gap-x-1 gap-y-1 auto-rows-min">
                            {blanks.map((_, i) => <div key={`b-${i}`} />)}
                            {days.map(d => {
                                const isPunched = punchSet.has(d);
                                return (
                                    <div key={d} className="aspect-square flex items-center justify-center">
                                        <div className={`w-3.5 h-3.5 rounded-full flex items-center justify-center text-[7px] transition-all ${isPunched ? `${dim.color || 'bg-slate-400'} text-white shadow-sm scale-110` : 'bg-slate-50 text-slate-200'}`}>
                                            {isPunched ? '' : d}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md flex items-center justify-center px-1 py-2 md:px-4 md:py-4 z-50 animate-fade-in overflow-hidden">
                    <div className="bg-slate-50 w-full max-w-full md:max-w-6xl rounded-[2.5rem] md:rounded-[3rem] flex flex-col h-[95vh] md:h-[85vh] shadow-2xl overflow-hidden relative">
                        <div className="p-6 pb-4 flex justify-between items-center bg-white rounded-t-[2.5rem] shadow-sm z-10">
                            <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-slate-50 rounded-full text-slate-400 active:scale-95"><Icon name="left" /></button>
                            <div className="text-center">
                                <h3 className="text-lg font-black text-slate-800 tracking-tight">{year}年 {month + 1}月</h3>
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mt-0.5">Progress Heatmap</p>
                            </div>
                            <button onClick={() => changeMonth(1)} className="p-2 hover:bg-slate-50 rounded-full text-slate-400 active:scale-95"><Icon name="right" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 no-scrollbar bg-slate-50">
                            <div className="grid grid-cols-2 gap-3 pb-20">
                                {activeDims.map(dim => <MiniCalendarCard key={dim.id} dim={dim} />)}
                            </div>
                        </div>
                        <div className="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-slate-50 to-transparent pointer-events-none flex justify-center">
                            <button onClick={onClose} className="pointer-events-auto bg-slate-900 text-white px-10 py-3.5 rounded-full font-black text-xs uppercase tracking-widest shadow-xl flex items-center gap-2 hover:scale-105 active:scale-95 transition-all mb-4">
                                <Icon name="close" size={16} /> 关闭
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 4. 主逻辑 App
        // ==========================================
        const INITIAL_SYSTEM_TAGS = [
            { id: 'tag_1', name: '人生中的第一次', appliesTo: [] }, // 空数组表示应用到所有维度
            { id: 'tag_2', name: '里程碑', appliesTo: [] }
        ];

        const App = () => {
            const [step, setStep] = useState(1);
            const [name, setName] = useState("");
            const [avatar, setAvatar] = useState(null);
            const [dimensions, setDimensions] = useState(INITIAL_DIMS);
            const [scores, setScores] = useState([]);
            const [history, setHistory] = useState([]);
            const [systemTags, setSystemTags] = useState(INITIAL_SYSTEM_TAGS);

            // Firebase Auth State
            const [currentUser, setCurrentUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [syncStatus, setSyncStatus] = useState('idle'); // 'idle' | 'syncing' | 'synced' | 'offline'

            // Modal States
            const [modalType, setModalType] = useState(null); // 'record' | 'calendar' | 'settings' | 'auth' | null
            const [selectedDimIdx, setSelectedDimIdx] = useState(0);
            const [editingRecordIdx, setEditingRecordIdx] = useState(null); // null 表示新建，数字表示编辑第几条记录
            const [customDimName, setCustomDimName] = useState("");

            const fileInputRef = useRef(null);

            // --- 常量 ---
            const STORAGE_KEY = 'life_matrix_v34_csv';

            // --- Firebase Auth 监听 ---
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    setCurrentUser(user);

                    if (user) {
                        // 用户已登录，从 Firestore 加载数据
                        await loadFromFirestore(user.uid);
                    } else {
                        // 用户未登录，从 localStorage 加载
                        loadFromLocalStorage();
                    }
                    // 数据加载完成后再关闭loading状态
                    setAuthLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // --- 从 localStorage 加载 ---
            const loadFromLocalStorage = () => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const data = JSON.parse(saved);
                        if (data) {
                            if (data.name) setName(data.name);
                            if (data.avatar) setAvatar(data.avatar);
                            if (data.dimensions) setDimensions(data.dimensions);
                            if (data.scores) setScores(data.scores);
                            if (data.history) setHistory(data.history);
                            if (data.systemTags) setSystemTags(data.systemTags);
                            if (data.name && data.scores && data.scores.length > 0) {
                                setStep(4);
                            }
                        }
                    }
                } catch (e) {
                    console.error("LocalStorage load error", e);
                }
            };

            // --- 从 Firestore 加载 ---
            const loadFromFirestore = async (userId) => {
                try {
                    setSyncStatus('syncing');
                    const doc = await db.collection('users').doc(userId).get();

                    if (doc.exists) {
                        const data = doc.data();
                        if (data.name) setName(data.name);
                        if (data.avatar) setAvatar(data.avatar);
                        if (data.dimensions) setDimensions(data.dimensions);
                        if (data.scores) setScores(data.scores);
                        if (data.history) setHistory(data.history);
                        if (data.systemTags) setSystemTags(data.systemTags);
                        if (data.name && data.scores && data.scores.length > 0) {
                            setStep(4);
                        }
                        // 同步到 localStorage 作为备份
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    } else {
                        // Firestore 没有数据，尝试从 localStorage 迁移
                        loadFromLocalStorage();
                    }
                    setSyncStatus('synced');
                } catch (e) {
                    console.error("Firestore load error", e);
                    setSyncStatus('offline');
                    loadFromLocalStorage();
                }
            };

            // --- 保存数据 ---
            const saveData = async (newScores, newHistory, newDims, newName, newAvatar, newSystemTags) => {
                const data = {
                    name: newName !== undefined ? newName : name,
                    avatar: newAvatar !== undefined ? newAvatar : avatar,
                    dimensions: newDims || dimensions,
                    scores: newScores || scores,
                    history: newHistory || history,
                    systemTags: newSystemTags || systemTags,
                    updatedAt: new Date().toISOString()
                };

                // 始终保存到 localStorage
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                } catch (e) { console.error("LocalStorage save error", e); }

                // 如果已登录，同步到 Firestore
                if (currentUser) {
                    try {
                        setSyncStatus('syncing');
                        await db.collection('users').doc(currentUser.uid).set(data, { merge: true });
                        setSyncStatus('synced');
                    } catch (e) {
                        console.error("Firestore save error", e);
                        setSyncStatus('offline');
                    }
                }
            };

            // --- 登录方法 ---
            const [authMode, setAuthMode] = useState('login'); // 'login' | 'register'
            const [authEmail, setAuthEmail] = useState('');
            const [authPassword, setAuthPassword] = useState('');
            const [authError, setAuthError] = useState('');

            const signInWithGoogle = async () => {
                try {
                    setAuthError('');
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithPopup(provider);
                } catch (e) {
                    console.error("Google sign-in error", e);
                    setAuthError(getAuthErrorMessage(e.code));
                }
            };

            const signInWithEmail = async () => {
                if (!authEmail || !authPassword) {
                    setAuthError('请填写邮箱和密码');
                    return;
                }
                try {
                    setAuthError('');
                    await auth.signInWithEmailAndPassword(authEmail, authPassword);
                } catch (e) {
                    console.error("Email sign-in error", e);
                    setAuthError(getAuthErrorMessage(e.code));
                }
            };

            const signUpWithEmail = async () => {
                if (!authEmail || !authPassword) {
                    setAuthError('请填写邮箱和密码');
                    return;
                }
                if (authPassword.length < 6) {
                    setAuthError('密码至少需要6位');
                    return;
                }
                try {
                    setAuthError('');
                    await auth.createUserWithEmailAndPassword(authEmail, authPassword);
                } catch (e) {
                    console.error("Email sign-up error", e);
                    setAuthError(getAuthErrorMessage(e.code));
                }
            };

            const getAuthErrorMessage = (code) => {
                const messages = {
                    'auth/email-already-in-use': '该邮箱已被注册',
                    'auth/invalid-email': '邮箱格式不正确',
                    'auth/weak-password': '密码强度太弱',
                    'auth/user-not-found': '用户不存在',
                    'auth/wrong-password': '密码错误',
                    'auth/too-many-requests': '尝试次数过多，请稍后再试',
                    'auth/popup-closed-by-user': '登录窗口被关闭',
                    'auth/network-request-failed': '网络连接失败'
                };
                return messages[code] || '登录失败，请重试';
            };

            const signOut = async () => {
                try {
                    await auth.signOut();
                    setSyncStatus('idle');
                    setStep(1);
                    setAuthEmail('');
                    setAuthPassword('');
                } catch (e) {
                    console.error("Sign out error", e);
                }
            };

            // --- 导出逻辑 ---
            const handleExportJSON = () => {
                const dataStr = JSON.stringify({ name, avatar, dimensions, scores, history });
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileDefaultName = `lifematrix_backup_${new Date().toISOString().slice(0, 10)}.json`;

                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };

            const handleExportCSV = () => {
                if (!history || history.length === 0) {
                    alert("暂无数据可导出");
                    return;
                }
                let csvContent = "\uFEFF日期,时间,维度,内容,获得积分\n";
                history.forEach(item => {
                    const dateObj = new Date(item.timestamp || Date.now());
                    const date = dateObj.toLocaleDateString('zh-CN');
                    const time = dateObj.toLocaleTimeString('zh-CN');
                    const content = `"${(item.text || "").replace(/"/g, '""')}"`;
                    const row = `${date},${time},${item.dimName},${content},${item.pts}`;
                    csvContent += row + "\n";
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `lifematrix_data_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImport = (jsonString) => {
                try {
                    const data = JSON.parse(jsonString);
                    if (!data.dimensions || !data.scores) {
                        alert("文件格式不正确");
                        return;
                    }
                    setName(data.name || "");
                    setAvatar(data.avatar || null);
                    setDimensions(data.dimensions);
                    setScores(data.scores);
                    setHistory(data.history || []);
                    saveData(data.scores, data.history, data.dimensions, data.name, data.avatar);
                    setStep(4);
                    setModalType(null);
                    alert("数据导入成功！");
                } catch (e) {
                    alert("解析失败，请检查文件是否损坏");
                }
            };

            // --- Handlers ---
            const handleAvatarUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 150; canvas.height = 150;
                        canvas.getContext('2d').drawImage(img, 0, 0, 150, 150);
                        setAvatar(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            };

            const addCustomDim = () => {
                if (!customDimName.trim() || dimensions.length >= 12) return;
                const newDims = [...dimensions, { id: `c_${Date.now()}`, name: customDimName, active: true, color: "bg-slate-400", text: "text-slate-400", border: "border-slate-200" }];
                setDimensions(newDims);
                setCustomDimName("");
            };

            const enterMatrix = () => {
                const initScores = new Array(dimensions.length).fill(0);
                setScores(initScores);
                setStep(4);
                saveData(initScores, [], null);
            };

            const handleRecordConfirm = (text) => {
                if (!text || !text.trim()) return;

                // Extract tags from inline text using 【】, [], or # patterns
                const tagRegex = /【([^】]+)】|\[([^\]]+)\]|#([^#]+)#/g;
                const extractedTags = [...new Set(Array.from(text.matchAll(tagRegex)).map(match => {
                    // match[1] = 【】, match[2] = [], match[3] = #
                    return (match[1] || match[2] || match[3]).trim();
                }))];

                // Sync extracted tags to systemTags (add new tags if they don't exist)
                let updatedSystemTags = [...systemTags];
                extractedTags.forEach(tagName => {
                    const tagExists = systemTags.some(t => t.name === tagName);
                    if (!tagExists) {
                        const newTag = {
                            id: `tag_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            name: tagName,
                            appliesTo: [] // Empty array means applies to all dimensions
                        };
                        updatedSystemTags.push(newTag);
                    }
                });

                // 如果是编辑模式，调用编辑函数
                if (editingRecordIdx !== null) {
                    handleRecordEdit(text, extractedTags, updatedSystemTags);
                    return;
                }

                const newScores = [...(scores || [])];
                while (newScores.length <= selectedDimIdx) newScores.push(0);
                newScores[selectedDimIdx] = (newScores[selectedDimIdx] || 0) + 1;

                const dim = dimensions[selectedDimIdx];

                const entry = {
                    dimName: dim?.name || "未知",
                    dimColor: dim?.color || "bg-slate-400",
                    text: text,
                    tags: extractedTags,
                    pts: 1,
                    timestamp: Date.now(),
                    dateStr: new Date().toLocaleDateString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                };

                const newHistory = [entry, ...(history || [])].slice(0, 100);
                setScores(newScores);
                setHistory(newHistory);
                setSystemTags(updatedSystemTags);
                setModalType(null);
                setEditingRecordIdx(null);
                saveData(newScores, newHistory, null, undefined, undefined, updatedSystemTags);
            };

            const handleRecordEdit = (text, tags = [], updatedSystemTags = null) => {
                if (!text || !text.trim() || editingRecordIdx === null) return;

                const newHistory = [...(history || [])];
                if (editingRecordIdx < newHistory.length) {
                    // 更新记录，保留原有的其他字段
                    newHistory[editingRecordIdx] = {
                        ...newHistory[editingRecordIdx],
                        text: text,
                        tags: tags
                    };
                    setHistory(newHistory);
                    if (updatedSystemTags) {
                        setSystemTags(updatedSystemTags);
                    }
                    setModalType(null);
                    setEditingRecordIdx(null);
                    saveData(null, newHistory, null, undefined, undefined, updatedSystemTags);
                }
            };

            const totalExp = (scores || []).reduce((a, b) => a + b, 0);
            const totalLevel = calculateLevel(totalExp);
            const balanceValue = calculateBalance(scores);

            // --- Views ---

            // 加载中状态
            if (authLoading) return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center">
                    <div className="text-center animate-fade-in">
                        <div className="inline-flex p-4 bg-sky-50 rounded-2xl text-sky-500 shadow-inner mb-4 animate-pulse"><Icon name="sparkle" size={32} /></div>
                        <p className="text-slate-400 text-sm font-bold">加载中...</p>
                    </div>
                </div>
            );

            // 登录/注册页面
            if (step === 1 && !currentUser) return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6">
                    <div className="bg-white w-full max-w-sm rounded-[3rem] p-10 shadow-xl shadow-slate-200/50 text-center animate-fade-in">
                        <div className="mb-8 space-y-4">
                            <div className="inline-flex p-4 bg-sky-50 rounded-2xl text-sky-500 shadow-inner"><Icon name="sparkle" size={32} /></div>
                            <h1 className="text-2xl font-black text-slate-800 tracking-tight">你好，旅行者。</h1>
                            <p className="text-slate-400 text-sm">欢迎进入人生这场无限游戏。</p>
                        </div>

                        <div className="space-y-4">
                            {/* Google 登录 */}
                            <button
                                onClick={signInWithGoogle}
                                className="w-full bg-white border-2 border-slate-200 hover:border-slate-300 hover:bg-slate-50 py-4 rounded-2xl flex items-center justify-center gap-3 transition-all"
                            >
                                <Icon name="google" size={20} className="text-slate-600" />
                                <span className="font-bold text-sm text-slate-700">使用 Google 继续</span>
                            </button>

                            <div className="flex items-center gap-4 my-6">
                                <div className="flex-1 h-px bg-slate-100"></div>
                                <span className="text-xs text-slate-300 font-bold">或使用邮箱</span>
                                <div className="flex-1 h-px bg-slate-100"></div>
                            </div>

                            {/* 邮箱表单 */}
                            <input
                                type="email"
                                value={authEmail}
                                onChange={e => setAuthEmail(e.target.value)}
                                placeholder="邮箱地址"
                                className="w-full bg-slate-50 rounded-2xl px-6 py-4 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-sky-100 transition-all"
                            />
                            <input
                                type="password"
                                value={authPassword}
                                onChange={e => setAuthPassword(e.target.value)}
                                placeholder="密码（至少6位）"
                                className="w-full bg-slate-50 rounded-2xl px-6 py-4 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-sky-100 transition-all"
                                onKeyDown={e => e.key === 'Enter' && signInWithEmail()}
                            />

                            {/* 错误提示 */}
                            {authError && (
                                <div className="bg-rose-50 border border-rose-100 rounded-xl px-4 py-3 text-rose-500 text-xs font-bold">
                                    {authError}
                                </div>
                            )}

                            {/* 登录 和 注册 按钮并排 */}
                            <div className="flex gap-3">
                                <button
                                    onClick={signInWithEmail}
                                    className="flex-1 bg-slate-900 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl hover:scale-[1.02] active:scale-95 transition-all"
                                >
                                    登录
                                </button>
                                <button
                                    onClick={signUpWithEmail}
                                    className="flex-1 bg-sky-500 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg hover:bg-sky-400 hover:scale-[1.02] active:scale-95 transition-all"
                                >
                                    注册
                                </button>
                            </div>

                            <p className="text-slate-300 text-[10px] text-center">
                                新用户直接点击「注册」，老用户点击「登录」
                            </p>
                        </div>
                    </div>
                </div>
            );

            // 如果用户已登录但是新用户(没有scores)，显示设置页面
            if (step === 1 && currentUser) return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6">
                    <div className="bg-white w-full max-w-sm rounded-[3rem] p-10 shadow-xl shadow-slate-200/50 text-center animate-fade-in">
                        <div className="mb-8 space-y-4">
                            <div className="inline-flex p-4 bg-emerald-50 rounded-2xl text-emerald-500 shadow-inner"><Icon name="check" size={32} /></div>
                            <h1 className="text-2xl font-black text-slate-800 tracking-tight">欢迎回来！</h1>
                            <p className="text-slate-400 text-sm">设置你的个人资料开始旅程。</p>
                        </div>
                        <div className="space-y-6 flex flex-col items-center">
                            <div className="relative cursor-pointer group" onClick={() => fileInputRef.current.click()}>
                                <div className={`w-28 h-28 rounded-[2.2rem] flex items-center justify-center overflow-hidden transition-all border-2 ${avatar ? 'border-sky-100 shadow-xl' : 'bg-slate-50 border-dashed border-slate-200 group-hover:border-sky-300'}`}>
                                    {avatar ? <img src={avatar} className="w-full h-full object-cover" /> : <Icon name="user" size={36} className="text-slate-300" />}
                                </div>
                                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleAvatarUpload} />
                                <div className="absolute -bottom-1 -right-1 bg-white p-2 rounded-xl shadow border border-slate-50 text-slate-400"><Icon name="camera" size={14} /></div>
                            </div>
                            <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="输入你的昵称" className="w-full bg-slate-50 rounded-2xl px-6 py-4 text-center font-bold text-slate-700 outline-none" />
                            <button onClick={() => name && setStep(2)} disabled={!name} className={`w-full py-4 rounded-2xl font-black text-xs uppercase tracking-widest ${name ? 'bg-slate-900 text-white shadow-xl hover:scale-[1.02] active:scale-95 transition-all' : 'bg-slate-100 text-slate-300'}`}>开始设置</button>
                        </div>
                    </div>
                </div>
            );

            if (step === 2) return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 max-w-lg mx-auto animate-fade-in">
                    <div className="bg-white w-full rounded-[3rem] p-8 shadow-xl shadow-slate-200/40 flex flex-col overflow-hidden">
                        <div className="mb-6 text-center">
                            <h3 className="text-2xl font-black text-slate-800 mb-2">人生是一场旷野。</h3>
                            <p className="text-sm font-bold text-slate-400">选择你想要点亮的方向：</p>
                        </div>
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            {dimensions.map((dim, idx) => (
                                <div key={dim.id} className={`flex items-center gap-3 p-4 rounded-2xl border transition-all duration-300 ${dim.active ? 'bg-slate-50 border-slate-100 shadow-inner' : 'opacity-25 grayscale hover:opacity-50'}`}>
                                    <input type="text" value={dim.name} onChange={e => {
                                        const newDims = [...dimensions];
                                        newDims[idx].name = e.target.value;
                                        setDimensions(newDims);
                                    }} className={`w-full bg-transparent border-none p-0 focus:ring-0 font-bold text-xs ${dim.active ? 'text-slate-700' : 'text-slate-400'}`} />
                                    <button onClick={() => {
                                        const activeCount = dimensions.filter(d => d.active).length;
                                        if (dim.active && activeCount <= 3) return;
                                        const newDims = [...dimensions];
                                        newDims[idx].active = !newDims[idx].active;
                                        setDimensions(newDims);
                                    }} className={`shrink-0 w-8 h-8 rounded-xl flex items-center justify-center transition-all ${dim.active ? 'bg-sky-500 text-white shadow-md' : 'bg-white border border-slate-100 text-slate-200'}`}>
                                        {dim.active ? <Icon name="check" size={14} strokeWidth={4} /> : <Icon name="plus" size={14} />}
                                    </button>
                                </div>
                            ))}
                        </div>
                        <div className="flex gap-2 mb-10 px-1">
                            <input type="text" value={customDimName} onChange={e => setCustomDimName(e.target.value)} placeholder="新增方向..." className="flex-1 bg-slate-50 border-none rounded-2xl px-5 py-3.5 text-xs font-bold outline-none" onKeyDown={e => e.key === 'Enter' && addCustomDim()} />
                            <button onClick={addCustomDim} className="bg-slate-900 text-white w-12 rounded-xl flex items-center justify-center shadow-lg"><Icon name="plus" size={18} /></button>
                        </div>
                        <div className="px-2 mb-8 space-y-2 text-center text-[11px] leading-relaxed">
                            <p className="font-bold text-slate-800">每个方向都是一段新的旅程。</p>
                            <p className="font-medium text-slate-400">完成任务会累积积分，带你不断升级。</p>
                            <p className="font-medium text-slate-400">你之后随时可以变换旅途的方向、顺序和目的地的名称。</p>
                        </div>
                        <div className="flex items-center gap-4 border-t border-slate-50 pt-8">
                            <button onClick={() => setStep(1)} className="text-slate-400 font-bold text-xs uppercase tracking-widest px-4">Back</button>
                            <button onClick={() => setStep(3)} className="flex-1 bg-sky-600 text-white py-4.5 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-sky-100 active:scale-[0.98] transition-all">确认开启</button>
                        </div>
                    </div>
                </div>
            );

            if (step === 3) return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 max-w-lg mx-auto animate-fade-in">
                    <div className="bg-white w-full rounded-[3.5rem] p-8 shadow-xl shadow-slate-200/40 flex flex-col items-center justify-center relative h-auto min-h-[550px]">
                        <div className="absolute top-10 left-10 flex items-center gap-3">
                            <div className="w-12 h-12 rounded-2xl bg-slate-50 border border-slate-100 shadow-sm overflow-hidden">
                                {avatar ? <img src={avatar} className="w-full h-full object-cover" /> : <Icon name="user" className="p-3 text-slate-200" />}
                            </div>
                            <div className="text-left">
                                <div className="text-base font-black text-slate-800 leading-none">{name}</div>
                                <div className="text-[10px] text-sky-500 font-bold uppercase tracking-widest mt-1">Voyager Initialized</div>
                            </div>
                        </div>
                        {/* 只读雷达图 */}
                        <RadarChart dimensions={dimensions} scores={new Array(dimensions.length).fill(0)} onLabelClick={() => { }} size={400} />
                        <div className="text-center space-y-8 w-full mt-2">
                            <p className="text-[10px] font-black text-slate-300 uppercase tracking-[0.4em]">LifeMatrix System Standby</p>
                            <div className="flex gap-4 w-full px-2">
                                <button onClick={() => setStep(2)} className="flex-1 py-4 text-slate-400 font-bold text-xs uppercase tracking-widest border border-slate-100 rounded-2xl">修改</button>
                                <button onClick={enterMatrix} className="flex-[2] bg-slate-900 text-white py-4.5 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all">进入矩阵</button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            // 4. Dashboard
            return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center p-4 md:p-8 pb-28">
                    {/* Header */}
                    <header className="w-full max-w-4xl flex justify-between items-start mb-8 relative">
                        {/* 左：日历 */}
                        <button onClick={() => setModalType('calendar')} aria-label="查看日历" className="p-3 bg-white rounded-2xl shadow-sm text-slate-400 hover:text-sky-500 transition-colors"><Icon name="clock" size={20} /></button>

                        <div className="flex flex-col items-center mt-2">
                            <div className="w-16 h-16 rounded-[1.8rem] bg-white p-1 shadow shadow-slate-200 overflow-hidden ring-4 ring-white border border-slate-50 mb-2">
                                {avatar ? <img src={avatar} className="w-full h-full object-cover rounded-[1.4rem]" /> : <Icon name="user" size={28} className="m-auto mt-4 text-slate-200" />}
                            </div>
                            <h2 className="text-xl font-black text-slate-800 leading-none mb-2">{name}</h2>
                            <div className="flex items-center gap-3">
                                <div className="flex items-center bg-slate-900 px-2.5 py-1 rounded-lg">
                                    <span className="text-[10px] font-black text-white uppercase tracking-tighter">Lv.{totalLevel}</span>
                                </div>
                                <div className="flex items-center gap-1.5 bg-white border border-slate-200 px-2.5 py-1 rounded-lg shadow-sm">
                                    <Icon name="scale" size={12} className="text-amber-500" />
                                    <span className="text-[10px] font-bold text-slate-600 tracking-tighter">平衡度 {balanceValue}%</span>
                                </div>
                            </div>
                            {/* 云同步状态 */}
                            <button
                                onClick={() => setModalType('auth')}
                                className={`mt-3 flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[10px] font-bold transition-all ${currentUser
                                    ? syncStatus === 'synced'
                                        ? 'bg-emerald-50 text-emerald-600 border border-emerald-100'
                                        : syncStatus === 'syncing'
                                            ? 'bg-sky-50 text-sky-500 border border-sky-100 animate-pulse'
                                            : 'bg-amber-50 text-amber-600 border border-amber-100'
                                    : 'bg-slate-100 text-slate-400 hover:bg-slate-200'
                                    }`}
                            >
                                <Icon name={currentUser ? (syncStatus === 'offline' ? 'cloudOff' : 'cloud') : 'cloud'} size={14} />
                                {currentUser
                                    ? syncStatus === 'synced'
                                        ? '已同步'
                                        : syncStatus === 'syncing'
                                            ? '同步中...'
                                            : '离线'
                                    : '登录同步'
                                }
                            </button>
                        </div>

                        {/* 右：设置 */}
                        <button onClick={() => setModalType('settings')} aria-label="设置" className="p-3 bg-white rounded-2xl shadow-sm text-slate-400 hover:text-slate-600 transition-colors"><Icon name="settings" size={20} /></button>
                    </header>

                    {/* Main Radar Card */}
                    <div className="w-full max-w-4xl bg-white rounded-[4rem] p-8 shadow-xl shadow-slate-200/50 flex flex-col items-center mb-10 relative overflow-visible min-h-[480px] justify-center">
                        <RadarChart
                            dimensions={dimensions}
                            scores={scores}
                            onLabelClick={(idx) => {
                                setSelectedDimIdx(idx);
                                setEditingRecordIdx(null); // 重置编辑状态
                                setModalType('record');
                            }}
                            size={400}
                        />
                        <div className="mt-4 text-[10px] font-black text-slate-300 uppercase tracking-[0.4em] animate-pulse">
                            Tap labels to record progress
                        </div>
                    </div>

                    {/* History Feed */}
                    <div className="w-full max-w-4xl">
                        <div className="flex items-center gap-2 mb-6 px-2">
                            <Icon name="history" size={16} className="text-slate-400" />
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest">最近记录</h3>
                        </div>
                        <div className="space-y-4 px-2">
                            {(!history || history.length === 0) ? (
                                <div className="text-center py-12 bg-white/50 border-2 border-dashed border-slate-100 rounded-[2.5rem] text-slate-300 text-xs font-bold uppercase tracking-widest">等候点亮记录</div>
                            ) : (
                                history.slice(0, 5).map((h, i) => (
                                    <div key={i} className="bg-white p-5 rounded-[2rem] shadow-sm flex items-center justify-between border border-transparent animate-fade-in group">
                                        <div className="flex items-center gap-4">
                                            <div className="w-10 h-10 rounded-2xl bg-sky-50 flex items-center justify-center text-sky-500 font-black text-sm">+{h.pts}</div>
                                            <div>
                                                <div className="text-sm font-bold text-slate-700 whitespace-pre-wrap">{h.text}</div>
                                                {h.tags && h.tags.length > 0 && (
                                                    <div className="flex flex-wrap gap-1 mt-1.5">
                                                        {h.tags.map((tag, ti) => (
                                                            <span key={ti} className="bg-violet-50 text-violet-500 px-2 py-0.5 rounded text-[9px] font-bold">【{tag}】</span>
                                                        ))}
                                                    </div>
                                                )}
                                                <div className="text-[10px] font-bold text-slate-400 uppercase mt-1">{h.dimName} · {h.dateStr}</div>
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => {
                                                setEditingRecordIdx(i);
                                                setModalType('record');
                                            }}
                                            className="p-2.5 rounded-xl bg-slate-50 text-slate-400 hover:bg-sky-50 hover:text-sky-500 transition-all md:opacity-0 md:group-hover:opacity-100"
                                            aria-label="编辑记录"
                                        >
                                            <Icon name="edit" size={16} />
                                        </button>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    {/* Modals */}
                    {modalType === 'record' && (
                        <RecordModal
                            dimName={editingRecordIdx !== null ? history[editingRecordIdx]?.dimName : dimensions[selectedDimIdx]?.name}
                            currentDimId={editingRecordIdx !== null
                                ? dimensions.find(d => d.name === history[editingRecordIdx]?.dimName)?.id
                                : dimensions[selectedDimIdx]?.id}
                            onClose={() => {
                                setModalType(null);
                                setEditingRecordIdx(null);
                            }}
                            onConfirm={handleRecordConfirm}
                            history={history}
                            systemTags={systemTags}
                            initialText={editingRecordIdx !== null ? history[editingRecordIdx]?.text : ""}
                            initialTags={editingRecordIdx !== null ? (history[editingRecordIdx]?.tags || []) : []}
                            isEdit={editingRecordIdx !== null}
                        />
                    )}

                    {modalType === 'calendar' && (
                        <MonthlyHistoryModal
                            onClose={() => setModalType(null)}
                            history={history}
                            dimensions={dimensions}
                        />
                    )}

                    {modalType === 'settings' && (
                        <SettingsModal
                            onClose={() => setModalType(null)}
                            onExportJSON={handleExportJSON}
                            onExportCSV={handleExportCSV}
                            onImport={handleImport}
                            name={name}
                            avatar={avatar}
                            dimensions={dimensions}
                            systemTags={systemTags}
                            onSave={(newName, newAvatar, newDims, newSystemTags) => {
                                if (newName !== undefined) setName(newName);
                                if (newAvatar !== undefined) setAvatar(newAvatar);
                                if (newDims) setDimensions(newDims);
                                if (newSystemTags) setSystemTags(newSystemTags);
                                saveData(null, null, newDims, newName, newAvatar, newSystemTags);
                            }}
                            onSignOut={signOut}
                            currentUser={currentUser}
                        />
                    )}

                    {/* 登录/账号弹窗 */}
                    {modalType === 'auth' && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-6 z-50 animate-fade-in">
                            <div className="bg-white w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl flex flex-col gap-5">
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="text-xl font-black text-slate-800">云同步</h3>
                                    <button onClick={() => setModalType(null)} className="text-slate-400 hover:text-slate-600"><Icon name="close" /></button>
                                </div>

                                {currentUser ? (
                                    <div className="space-y-4">
                                        <div className="bg-emerald-50 border border-emerald-100 rounded-2xl p-4 text-center">
                                            <div className="text-emerald-600 font-bold text-sm mb-1">已登录</div>
                                            <div className="text-emerald-500 text-xs truncate">{currentUser.email}</div>
                                        </div>
                                        <p className="text-xs text-slate-400 text-center">你的数据会自动同步到云端，可在任何设备访问。</p>
                                        <button
                                            onClick={async () => { await saveData(); }}
                                            className="w-full bg-sky-50 border border-sky-100 hover:bg-sky-100 py-4 rounded-2xl flex items-center justify-center gap-3 transition-all group"
                                        >
                                            <span className="p-1.5 bg-white rounded-full shadow-sm text-sky-500"><Icon name="cloud" size={16} /></span>
                                            <span className="font-bold text-xs text-sky-600">立即同步</span>
                                        </button>
                                        <button
                                            onClick={() => { signOut(); setModalType(null); }}
                                            className="w-full bg-slate-50 border border-slate-100 hover:bg-slate-100 py-4 rounded-2xl flex items-center justify-center gap-3 transition-all group"
                                        >
                                            <span className="p-1.5 bg-white rounded-full shadow-sm text-slate-400"><Icon name="logout" size={16} /></span>
                                            <span className="font-bold text-xs text-slate-500">退出登录</span>
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        <p className="text-xs text-slate-400 text-center">登录后，你的数据将同步到云端，可在任何设备访问。</p>
                                        <button
                                            onClick={signInWithGoogle}
                                            className="w-full bg-white border-2 border-slate-200 hover:border-slate-300 hover:bg-slate-50 py-4 rounded-2xl flex items-center justify-center gap-3 transition-all group"
                                        >
                                            <Icon name="google" size={20} className="text-slate-600" />
                                            <span className="font-bold text-sm text-slate-700">使用 Google 登录</span>
                                        </button>
                                        <p className="text-[10px] text-slate-300 text-center">你目前的数据保存在本地，登录后会自动迁移到云端。</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}


                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>